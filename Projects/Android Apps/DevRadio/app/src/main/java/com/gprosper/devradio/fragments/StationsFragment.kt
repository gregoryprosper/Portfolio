package com.gprosper.devradio.fragments


import android.content.Intent
import android.graphics.Rect
import android.os.Bundle
import android.support.v4.app.Fragment
import android.support.v7.widget.LinearLayoutManager
import android.support.v7.widget.RecyclerView
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import com.gprosper.devradio.R
import com.gprosper.devradio.adapters.StationsAdapter
import com.gprosper.devradio.constants.BROADCAST_STATION_CLICKED
import com.gprosper.devradio.services.DataService


/**
 * A simple [Fragment] subclass.
 * Use the [StationsFragment.newInstance] factory method to
 * create an instance of this fragment.
 */
class StationsFragment : Fragment() {
    private lateinit var stationsAdapter: StationsAdapter
    private var stationType: Int? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        if (arguments != null) {
            stationType = arguments.getInt(ARG_STATION_TYPE) ?: STATION_TYPE_FEATURED
        }
    }

    override fun onCreateView(inflater: LayoutInflater?, container: ViewGroup?,
                              savedInstanceState: Bundle?): View? {
        return inflater!!.inflate(R.layout.fragment_stations, container, false).apply {
            val recyclerView = findViewById<RecyclerView>(R.id.stations_recyclerView)

            val stations = when(stationType){
                STATION_TYPE_FEATURED -> DataService.getFeaturedStations()
                STATION_TYPE_RECENT -> DataService.getFeaturedStations()
                STATION_TYPE_PARTY -> DataService.getFeaturedStations()
                else -> DataService.getFeaturedStations()
            }

            stationsAdapter = StationsAdapter(stations).apply {
                itemSelectedListener = { station ->
                    val intent = Intent(BROADCAST_STATION_CLICKED)
                    intent.putExtra(BROADCAST_STATION_CLICKED, station)
                    context.sendBroadcast(intent)
                }
            }

            recyclerView.setHasFixedSize(true)
            recyclerView.adapter = stationsAdapter
            recyclerView.addItemDecoration(HorizontalSpaceItemDecorator(30))
            recyclerView.layoutManager = LinearLayoutManager(context).apply {
                orientation = LinearLayoutManager.HORIZONTAL
            }
        }
    }

    companion object {
        const val STATION_TYPE_FEATURED = 0
        const val STATION_TYPE_RECENT = 1
        const val STATION_TYPE_PARTY = 2

        private const val ARG_STATION_TYPE = "ARG_STATION_TYPE"

        fun newInstance(stationType: Int): StationsFragment {
            val fragment = StationsFragment()
            val args = Bundle()
            args.putInt(ARG_STATION_TYPE, stationType)
            fragment.arguments = args
            return fragment
        }
    }

    class HorizontalSpaceItemDecorator(private val spacer: Int) : RecyclerView.ItemDecoration() {
        override fun getItemOffsets(outRect: Rect?, view: View?, parent: RecyclerView?, state: RecyclerView.State?) {
            super.getItemOffsets(outRect, view, parent, state)
            outRect?.right = spacer
        }
    }
}
